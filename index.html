<!DOCTYPE html>
<html class="light" dir="rtl" lang="he">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Bfair - בדיקת רכב</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f1c822",
                        "background-light": "#f8f8f6",
                        "background-dark": "#181711",
                        "surface-light": "#ffffff",
                        "surface-dark": "#221e10",
                        "text-light": "#181711",
                        "text-dark": "#f5f4f0",
                        "text-muted-light": "#8a8260",
                        "text-muted-dark": "#8a8260",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Manrope', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-display">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <!-- Header -->
            <header class="sticky top-0 z-50 bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-sm">
                <div class="container mx-auto px-4">
                    <div class="flex items-center justify-center whitespace-nowrap border-b border-solid border-primary/20 h-32">
                        <div class="flex items-center gap-4">
                            <img src="logo.jpeg" alt="Bfair" class="h-28">
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-grow">
                <!-- Hero Section with Search -->
                <div class="@container relative">
                    <div class="flex min-h-[600px] flex-col gap-8 bg-cover bg-center bg-no-repeat items-center justify-center p-4 text-center" style='background-image: linear-gradient(rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.6) 100%), url("https://lh3.googleusercontent.com/aida-public/AB6AXuA9f5JSlWMY2r9YkC6ZtbGoGfyL2Pc6Vuq5d7wCl-zXVDOQV90QsAJ9YMxXZshZs5QyhLRONshdJaxSEy_gyty-qux0vfqsoXCWpP3shZwiu2ayXCsKA9Gbm68M9wGoIsBRHKIikkq8IVJz7YtqnVbwzpGcRX0mmBIS-l_FrEHMc_tB2_xZt6YQZB4Yk8Tnzf7Cb3JieshEvpCx8i-oaA2ar5Gd0hix0u-A4LGVBVfllCtALE5f5eWohA5o1bw83N5K45pydqVISvUU");'>

                        <div class="flex flex-col gap-4 max-w-3xl">
                            <h1 class="text-white text-4xl font-black leading-tight tracking-[-0.033em] md:text-6xl">בדיקת פרטי רכב</h1>
                            <h2 class="text-white/90 text-lg font-normal leading-normal md:text-xl">הזן מספר רישוי או העלה תמונה לקבלת מידע מלא על הרכב</h2>
                        </div>

                        <!-- Search Card -->
                        <div class="w-full max-w-3xl bg-surface-light/20 dark:bg-surface-dark/20 backdrop-blur-md p-4 rounded-xl shadow-lg">
                            <!-- Tabs -->
                            <div class="flex-wrap gap-4 flex justify-center mb-4">
                                <button id="tab-manual" class="tab-btn flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary/30 text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/50 transition-colors" onclick="switchTab('manual')">
                                    <span class="truncate">הזנה ידנית</span>
                                </button>
                                <button id="tab-upload" class="tab-btn flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-background-light/30 text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-background-light/50 transition-colors" onclick="switchTab('upload')">
                                    <span class="truncate">העלאת תמונה</span>
                                </button>
                            </div>

                            <!-- Manual Input -->
                            <div id="manual-content" class="tab-content">
                                <form id="searchForm">
                                    <label class="flex flex-col h-14 w-full">
                                        <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                                            <div class="text-text-light flex bg-surface-light dark:bg-surface-dark items-center justify-center pr-4 rounded-r-lg">
                                                <span class="material-symbols-outlined">search</span>
                                            </div>
                                            <input
                                                type="text"
                                                id="licensePlate"
                                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden text-text-light dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary border-none bg-surface-light dark:bg-surface-dark h-full placeholder:text-text-muted-light dark:placeholder:text-text-muted-dark px-4 text-base font-normal leading-normal text-center tracking-widest"
                                                placeholder="הזן מספר רישוי"
                                                maxlength="8"
                                                style="direction: ltr;"
                                                required
                                            />
                                            <button type="submit" id="searchBtn" class="flex min-w-[100px] cursor-pointer items-center justify-center overflow-hidden rounded-l-lg h-full px-5 bg-primary text-text-light text-base font-bold hover:bg-opacity-90 transition-opacity">
                                                <span class="truncate">חיפוש</span>
                                            </button>
                                        </div>
                                    </label>
                                </form>
                            </div>

                            <!-- Image Upload -->
                            <div id="upload-content" class="tab-content hidden">
                                <div id="uploadArea" class="border-2 border-dashed border-white/30 rounded-lg p-8 text-center cursor-pointer hover:border-primary hover:bg-primary/10 transition-all">
                                    <span class="material-symbols-outlined text-5xl text-primary mb-3">photo_camera</span>
                                    <p class="text-white font-medium mb-1">לחץ להעלאת תמונה או גרור לכאן</p>
                                    <p class="text-white/70 text-sm">JPEG, PNG או WebP עד 10MB</p>
                                    <input type="file" id="fileInput" class="hidden" accept="image/jpeg,image/png,image/webp">
                                </div>

                                <div id="previewContainer" class="hidden mt-4">
                                    <img id="previewImage" class="w-full max-h-48 object-contain rounded-lg mb-4" alt="Preview">
                                    <div id="extractedPlate" class="hidden bg-surface-light/90 rounded-lg p-4 mb-4">
                                        <p class="text-text-muted-light text-sm mb-1">מספר רישוי שזוהה:</p>
                                        <p id="extractedPlateValue" class="text-2xl font-bold text-primary tracking-widest" style="direction: ltr;"></p>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="searchExtractedBtn" disabled class="flex-1 h-12 rounded-lg bg-primary text-text-light font-bold hover:bg-opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed">
                                            חפש רכב
                                        </button>
                                        <button id="clearUploadBtn" class="h-12 px-4 rounded-lg bg-surface-light text-text-muted-light font-medium hover:bg-gray-200 transition-colors">
                                            נקה
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <section id="resultsSection" class="hidden py-16 sm:py-24">
                    <div class="container mx-auto px-4 max-w-4xl">
                        <div id="resultsContent" class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg p-6">
                            <!-- Results will be injected here -->
                        </div>
                    </div>
                </section>
            </main>

            <!-- Footer -->
            <footer class="bg-surface-dark text-background-light">
                <div class="container mx-auto px-4 py-16">
                    <div class="flex flex-col items-center">
                        <img src="logo.jpeg" alt="Bfair" class="h-24 mb-4">
                        <p class="text-text-muted-dark text-center max-w-md">בדיקת פרטי רכב מהירה ומדויקת. הזן מספר רישוי או העלה תמונה לקבלת מידע מלא.</p>
                    </div>
                    <div class="mt-8 border-t border-primary/20 pt-8 text-center text-text-muted-dark">
                        <p>© 2024 Bfair. כל הזכויות שמורות.</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        const API_BASE = 'https://data.gov.il/api/3/action/datastore_search';
        const RESOURCE_ID = '053cea08-09bc-40ec-8f7a-156f0677aff3';
        const VISION_API = '/api/extract-plate';

        let extractedPlateNumber = null;

        const fieldLabels = {
            'mispar_rechev': 'מספר רכב',
            'tozeret_nm': 'יצרן',
            'kinuy_mishari': 'דגם מסחרי',
            'degem_nm': 'דגם',
            'ramat_gimur': 'רמת גימור',
            'shnat_yitzur': 'שנת ייצור',
            'tzeva_rechev': 'צבע',
            'sug_delek_nm': 'סוג דלק',
            'baalut': 'בעלות',
            'misgeret': 'מספר שלדה',
            'tokef_dt': 'תוקף רישיון',
            'mivchan_acharon_dt': 'מבחן אחרון',
            'kvutzat_zihum': 'קבוצת זיהום',
            'degem_manoa': 'דגם מנוע',
            'horaat_rishum': 'הוראת רישום',
            'moed_aliya_lakvish': 'מועד עליה לכביש',
            'zmig_kidmi': 'צמיג קדמי',
            'zmig_ahori': 'צמיג אחורי',
            'tozeret_cd': 'קוד יצרן',
            'degem_cd': 'קוד דגם',
            'tzeva_cd': 'קוד צבע',
            'sug_degem': 'סוג דגם',
            'ramat_eivzur_betihuty': 'רמת אבזור בטיחותי'
        };

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary/30');
                btn.classList.add('bg-background-light/30');
            });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tab}`).classList.add('bg-primary/30');
            document.getElementById(`tab-${tab}`).classList.remove('bg-background-light/30');
            document.getElementById(`${tab}-content`).classList.remove('hidden');
        }

        // Upload area
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const extractedPlate = document.getElementById('extractedPlate');
        const extractedPlateValue = document.getElementById('extractedPlateValue');
        const searchExtractedBtn = document.getElementById('searchExtractedBtn');
        const clearUploadBtn = document.getElementById('clearUploadBtn');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-primary', 'bg-primary/10');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-primary', 'bg-primary/10');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-primary', 'bg-primary/10');
            const file = e.dataTransfer.files[0];
            if (file) handleFileUpload(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file);
        });

        async function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                uploadArea.classList.add('hidden');
            };
            reader.readAsDataURL(file);

            extractedPlate.classList.add('hidden');
            searchExtractedBtn.disabled = true;
            searchExtractedBtn.textContent = 'מזהה לוחית...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(VISION_API, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    extractedPlateNumber = data.licensePlate;
                    extractedPlateValue.textContent = data.licensePlate;
                    extractedPlate.classList.remove('hidden');
                    searchExtractedBtn.textContent = 'חפש רכב';
                    searchExtractedBtn.disabled = false;
                    // Auto-search when plate is detected
                    searchVehicle(extractedPlateNumber);
                } else {
                    alert(data.error || 'לא זוהתה לוחית רישוי בתמונה');
                    searchExtractedBtn.textContent = 'חפש רכב';
                    searchExtractedBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בזיהוי לוחית הרישוי');
                searchExtractedBtn.textContent = 'חפש רכב';
                searchExtractedBtn.disabled = true;
            }
        }

        searchExtractedBtn.addEventListener('click', () => {
            if (extractedPlateNumber) {
                searchVehicle(extractedPlateNumber);
            }
        });

        clearUploadBtn.addEventListener('click', () => {
            previewContainer.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            extractedPlate.classList.add('hidden');
            extractedPlateNumber = null;
            fileInput.value = '';
            searchExtractedBtn.disabled = true;
        });

        // Search form
        const searchForm = document.getElementById('searchForm');
        const licensePlateInput = document.getElementById('licensePlate');
        const searchBtn = document.getElementById('searchBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const licensePlate = licensePlateInput.value.replace(/[-\s]/g, '').trim();
            if (licensePlate) {
                searchVehicle(licensePlate);
            }
        });

        async function searchVehicle(licensePlate) {
            searchBtn.disabled = true;
            searchExtractedBtn.disabled = true;
            resultsSection.classList.remove('hidden');
            resultsContent.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block h-10 w-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
                    <p class="text-text-muted-light">מחפש נתונים...</p>
                </div>
            `;
            // Auto-scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            try {
                const filters = JSON.stringify({ mispar_rechev: parseInt(licensePlate) });
                const url = `${API_BASE}?resource_id=${RESOURCE_ID}&filters=${encodeURIComponent(filters)}&limit=1`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error('API request failed');
                }

                const records = data.result.records;

                if (records.length === 0) {
                    resultsContent.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-5xl text-text-muted-light mb-4">search_off</span>
                            <p class="text-text-muted-light">לא נמצאו תוצאות עבור מספר רישוי: ${licensePlate}</p>
                        </div>
                    `;
                    return;
                }

                displayResults(records[0]);

            } catch (error) {
                console.error('Error:', error);
                resultsContent.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl text-red-500 mb-4">error</span>
                        <p class="text-red-500">אירעה שגיאה בחיפוש. אנא נסה שנית.</p>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                if (extractedPlateNumber) {
                    searchExtractedBtn.disabled = false;
                }
            }
        }

        function displayResults(vehicle) {
            const plateNumber = vehicle.mispar_rechev || licensePlateInput.value;

            let infoItems = '';

            for (const [key, value] of Object.entries(vehicle)) {
                if (value && key !== '_id' && key !== 'rank') {
                    const label = fieldLabels[key] || key;
                    let displayValue = value;

                    if (key.includes('_dt') && value) {
                        const date = new Date(value);
                        if (!isNaN(date)) {
                            displayValue = date.toLocaleDateString('he-IL');
                        }
                    }

                    if (key === 'automatic_ind') {
                        displayValue = value === 'A' ? 'כן' : 'לא';
                    }

                    infoItems += `
                        <div class="group flex flex-col overflow-hidden rounded-xl border border-surface-light bg-background-light shadow-sm transition-shadow hover:shadow-lg p-4">
                            <p class="text-sm font-medium text-text-muted-light mb-1">${label}</p>
                            <p class="text-lg font-bold text-text-light">${displayValue}</p>
                        </div>
                    `;
                }
            }

            resultsContent.innerHTML = `
                <div class="rounded-lg bg-surface-light p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-col">
                            <p class="text-[28px] font-bold leading-tight tracking-tight text-text-light">
                                ${vehicle.tozeret_nm || ''} ${vehicle.kinuy_mishari || ''}
                            </p>
                            <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-sm text-text-muted-light">
                                <span>${vehicle.shnat_yitzur || ''}</span>
                                <span>•</span>
                                <span>${vehicle.tzeva_rechev || ''}</span>
                                <span>•</span>
                                <span>${vehicle.sug_delek_nm || ''}</span>
                            </div>
                        </div>
                        <span class="bg-primary text-text-light px-6 py-3 rounded-lg text-2xl font-extrabold tracking-widest" style="direction: ltr;">${plateNumber}</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${infoItems}
                </div>
            `;
        }
    </script>
</body>
</html>
