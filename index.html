<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bfair - בדיקת רכב</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap');

        body {
            font-family: 'Heebo', sans-serif;
            background-color: #0a0a0a;
            color: #e5e5e5;
        }

        .text-gold-gradient {
            background: linear-gradient(45deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-premium {
            background: linear-gradient(90deg, #d4af37 0%, #C5A028 100%);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
        }
        .btn-premium:hover {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            transform: translateY(-2px);
        }

        .bg-concrete {
            background-color: #111111;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23222222' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            transition: 0.3s;
        }
        .glass-input:focus {
            border-color: #BF953F;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <nav class="fixed w-full z-50 bg-black/80 backdrop-blur-md border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-center items-center h-24">
                <img src="logo.jpeg" alt="Bfair Logo" class="h-16 w-auto object-contain filter brightness-110 contrast-125">
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative bg-concrete min-h-screen flex items-center justify-center pt-20 overflow-hidden">

        <!-- Background effects -->
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-[#BF953F] rounded-full mix-blend-overlay filter blur-[128px] opacity-20 animate-pulse"></div>
        <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-900 rounded-full mix-blend-overlay filter blur-[128px] opacity-20"></div>

        <div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center w-full">

            <h1 class="text-4xl md:text-6xl font-black text-white mb-4 tracking-tight">
                בדיקת <span class="text-gold-gradient">פרטי רכב</span>
            </h1>

            <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-400 mb-8 font-light">
                הזן מספר רישוי או העלה תמונה לקבלת מידע מלא על הרכב
            </p>

            <!-- Search Card -->
            <div class="bg-white/5 backdrop-blur-lg border border-white/10 p-6 rounded-xl max-w-3xl mx-auto shadow-2xl">

                <!-- Tabs -->
                <div class="flex gap-4 justify-center mb-6">
                    <button id="tab-manual" class="tab-btn px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wider transition-all bg-[#BF953F] text-black" onclick="switchTab('manual')">
                        הזנה ידנית
                    </button>
                    <button id="tab-upload" class="tab-btn px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wider transition-all bg-white/10 text-gray-300 hover:bg-white/20" onclick="switchTab('upload')">
                        העלאת תמונה
                    </button>
                </div>

                <!-- Manual Input -->
                <div id="manual-content" class="tab-content">
                    <form id="searchForm" class="flex gap-3">
                        <input
                            type="text"
                            id="licensePlate"
                            class="glass-input flex-1 p-4 rounded-lg text-center text-lg tracking-widest placeholder:text-gray-500"
                            placeholder="הזן מספר רישוי"
                            maxlength="8"
                            style="direction: ltr;"
                            required
                        />
                        <button type="submit" id="searchBtn" class="btn-premium text-black font-black py-4 px-8 rounded-lg uppercase tracking-wide">
                            חיפוש
                        </button>
                    </form>
                </div>

                <!-- Image Upload -->
                <div id="upload-content" class="tab-content hidden">
                    <!-- Upload Type Selection -->
                    <div id="uploadTypeSelection" class="grid grid-cols-2 gap-4 mb-4">
                        <div id="uploadVehicle" class="border-2 border-dashed border-white/20 rounded-lg p-6 text-center cursor-pointer hover:border-[#BF953F] hover:bg-[#BF953F]/10 transition-all">
                            <span class="material-symbols-outlined text-4xl text-[#BF953F] mb-2">directions_car</span>
                            <p class="text-white font-medium text-sm mb-1">צילום הרכב</p>
                            <p class="text-gray-500 text-xs">כולל לוחית רישוי</p>
                        </div>
                        <div id="uploadLicense" class="border-2 border-dashed border-white/20 rounded-lg p-6 text-center cursor-pointer hover:border-[#BF953F] hover:bg-[#BF953F]/10 transition-all">
                            <span class="material-symbols-outlined text-4xl text-[#BF953F] mb-2">description</span>
                            <p class="text-white font-medium text-sm mb-1">צילום רישיון רכב</p>
                            <p class="text-gray-500 text-xs">מסמך הרישיון</p>
                        </div>
                    </div>

                    <input type="file" id="fileInputVehicle" class="hidden" accept="image/jpeg,image/png,image/webp">
                    <input type="file" id="fileInputLicense" class="hidden" accept="image/jpeg,image/png,image/webp,application/pdf">

                    <div id="previewContainer" class="hidden mt-4">
                        <img id="previewImage" class="w-full max-h-48 object-contain rounded-lg mb-4" alt="Preview">
                        <div id="extractedPlate" class="hidden bg-white/10 rounded-lg p-4 mb-4">
                            <p class="text-gray-400 text-sm mb-1">מספר רישוי שזוהה:</p>
                            <p id="extractedPlateValue" class="text-2xl font-bold text-[#BF953F] tracking-widest" style="direction: ltr;"></p>
                        </div>
                        <div class="flex gap-3">
                            <button id="searchExtractedBtn" disabled class="flex-1 btn-premium text-black font-bold py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                חפש רכב
                            </button>
                            <button id="clearUploadBtn" class="py-3 px-4 rounded-lg bg-white/10 text-gray-300 font-medium hover:bg-white/20 transition-colors">
                                נקה
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Trust badges -->
                <div class="mt-4 text-gray-500 text-sm flex justify-center gap-6">
                    <span class="flex items-center gap-1"><span class="text-[#BF953F]">✓</span> 100% שקיפות</span>
                    <span class="flex items-center gap-1"><span class="text-[#BF953F]">✓</span> בדיקה מקיפה</span>
                    <span class="flex items-center gap-1"><span class="text-[#BF953F]">✓</span> אחריות Bfair</span>
                </div>
            </div>
        </div>

        <!-- Wave SVG -->
        <svg class="absolute bottom-0 left-0 w-full h-auto opacity-10 pointer-events-none" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
            <path fill="#BF953F" fill-opacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
        </svg>
    </div>

    <!-- Features Section -->
    <div class="bg-black py-20 border-t border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-12 text-center">
            <div>
                <div class="w-16 h-16 bg-gradient-to-br from-[#BF953F] to-[#FCF6BA] rounded-2xl rotate-45 mx-auto mb-6 flex items-center justify-center shadow-[0_0_30px_rgba(191,149,63,0.3)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-black -rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">סטנדרט אמינות חדש</h3>
                <p class="text-gray-500">כל רכב עובר תהליך אימות קפדני. אין הפתעות, רק שקט נפשי.</p>
            </div>
            <div>
                <div class="w-16 h-16 bg-gradient-to-br from-[#BF953F] to-[#FCF6BA] rounded-2xl rotate-45 mx-auto mb-6 flex items-center justify-center shadow-[0_0_30px_rgba(191,149,63,0.3)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-black -rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">חוויה ספורטיבית ומהירה</h3>
                <p class="text-gray-500">ממשק משתמש מהיר, חיפוש מתקדם, וסגירת עסקה ללא בירוקרטיה מיותרת.</p>
            </div>
            <div>
                <div class="w-16 h-16 bg-gradient-to-br from-[#BF953F] to-[#FCF6BA] rounded-2xl rotate-45 mx-auto mb-6 flex items-center justify-center shadow-[0_0_30px_rgba(191,149,63,0.3)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-black -rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">Fair Value</h3>
                <p class="text-gray-500">תמחור הוגן ושקוף המבוסס על נתוני אמת של השוק.</p>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <section id="resultsSection" class="hidden py-16 bg-black">
        <div class="container mx-auto px-4 max-w-4xl">
            <div id="resultsContent" class="bg-white/5 backdrop-blur-lg border border-white/10 rounded-xl p-6">
                <!-- Results will be injected here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black border-t border-white/10">
        <div class="container mx-auto px-4 py-12">
            <div class="flex flex-col items-center">
                <img src="logo.jpeg" alt="Bfair" class="h-16 mb-4">
                <p class="text-gray-500 text-center max-w-md text-sm">בדיקת פרטי רכב מהירה ומדויקת. הזן מספר רישוי או העלה תמונה לקבלת מידע מלא.</p>
            </div>
            <div class="mt-6 border-t border-white/10 pt-6 text-center text-gray-600 text-sm">
                <p>&copy; 2024 Bfair. כל הזכויות שמורות.</p>
            </div>
        </div>
    </footer>

    <script>
        const VISION_API = '/api/extract-plate';
        let extractedPlateNumber = null;

        const fieldLabels = {
            'mispar_rechev': 'מספר רכב',
            'tozeret_nm': 'יצרן',
            'kinuy_mishari': 'דגם מסחרי',
            'degem_nm': 'דגם',
            'ramat_gimur': 'רמת גימור',
            'shnat_yitzur': 'שנת ייצור',
            'tzeva_rechev': 'צבע',
            'sug_delek_nm': 'סוג דלק',
            'baalut': 'בעלות',
            'misgeret': 'מספר שלדה',
            'tokef_dt': 'תוקף רישיון',
            'moed_aliya_lakvish': 'מועד עליה לכביש',
            'zmig_kidmi': 'צמיג קדמי',
            'zmig_ahori': 'צמיג אחורי',
            'koah_sus': 'כוח סוס',
            'nefah_manoa': 'נפח מנוע (סמ"ק)',
            'mishkal_kolel': 'משקל כולל (ק"ג)',
            'mispar_dlatot': 'מספר דלתות',
            'mispar_moshavim': 'מספר מושבים',
            'automatic_ind': 'אוטומטי',
            'merkav': 'סוג מרכב',
            'madad_yarok': 'מדד ירוק',
            'kvutzat_zihum': 'קבוצת זיהום',
            'kilometer': 'קילומטראז אחרון',
            'shinui_mivne': 'שינוי מבנה',
            'shinui_tzeva': 'שינוי צבע',
            'rishum_rishon': 'רישום ראשון',
            'mispar_yadayim': 'מספר ידיים',
            'shinui_baalut_acharon': 'שינוי בעלות אחרון',
            'rechev_lo_pail': 'פעילות הרכב',
            'rechev_butal': 'סטטוס רישום',
            'taarich_bitul': 'תאריך ביטול',
            'tipul_baichor': 'תוקף טסט'
        };

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-[#BF953F]', 'text-black');
                btn.classList.add('bg-white/10', 'text-gray-300');
            });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            document.getElementById(`tab-${tab}`).classList.add('bg-[#BF953F]', 'text-black');
            document.getElementById(`tab-${tab}`).classList.remove('bg-white/10', 'text-gray-300');
            document.getElementById(`${tab}-content`).classList.remove('hidden');
        }

        // Upload areas
        const uploadTypeSelection = document.getElementById('uploadTypeSelection');
        const uploadVehicle = document.getElementById('uploadVehicle');
        const uploadLicense = document.getElementById('uploadLicense');
        const fileInputVehicle = document.getElementById('fileInputVehicle');
        const fileInputLicense = document.getElementById('fileInputLicense');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const extractedPlate = document.getElementById('extractedPlate');
        const extractedPlateValue = document.getElementById('extractedPlateValue');
        const searchExtractedBtn = document.getElementById('searchExtractedBtn');
        const clearUploadBtn = document.getElementById('clearUploadBtn');

        let currentUploadType = 'vehicle'; // 'vehicle' or 'license'

        uploadVehicle.addEventListener('click', () => {
            currentUploadType = 'vehicle';
            fileInputVehicle.click();
        });

        uploadLicense.addEventListener('click', () => {
            currentUploadType = 'license';
            fileInputLicense.click();
        });

        fileInputVehicle.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file, 'vehicle');
        });

        fileInputLicense.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file, 'license');
        });

        async function handleFileUpload(file, uploadType) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                uploadTypeSelection.classList.add('hidden');
            };
            reader.readAsDataURL(file);

            extractedPlate.classList.add('hidden');
            searchExtractedBtn.disabled = true;
            searchExtractedBtn.textContent = uploadType === 'license' ? 'קורא רישיון...' : 'מזהה לוחית...';

            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('type', uploadType);

                const response = await fetch(VISION_API, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    extractedPlateNumber = data.licensePlate;
                    extractedPlateValue.textContent = data.licensePlate;
                    extractedPlate.classList.remove('hidden');
                    searchExtractedBtn.textContent = 'חפש רכב';
                    searchExtractedBtn.disabled = false;
                    searchVehicle(extractedPlateNumber);
                } else {
                    alert(data.error || (uploadType === 'license' ? 'לא זוהה מספר רישוי ברישיון' : 'לא זוהתה לוחית רישוי בתמונה'));
                    searchExtractedBtn.textContent = 'חפש רכב';
                    searchExtractedBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בזיהוי מספר הרישוי');
                searchExtractedBtn.textContent = 'חפש רכב';
                searchExtractedBtn.disabled = true;
            }
        }

        searchExtractedBtn.addEventListener('click', () => {
            if (extractedPlateNumber) {
                searchVehicle(extractedPlateNumber);
            }
        });

        clearUploadBtn.addEventListener('click', () => {
            previewContainer.classList.add('hidden');
            uploadTypeSelection.classList.remove('hidden');
            extractedPlate.classList.add('hidden');
            extractedPlateNumber = null;
            fileInputVehicle.value = '';
            fileInputLicense.value = '';
            searchExtractedBtn.disabled = true;
        });

        // Search form
        const searchForm = document.getElementById('searchForm');
        const licensePlateInput = document.getElementById('licensePlate');
        const searchBtn = document.getElementById('searchBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const licensePlate = licensePlateInput.value.replace(/[-\s]/g, '').trim();
            if (licensePlate) {
                searchVehicle(licensePlate);
            }
        });

        async function searchVehicle(licensePlate) {
            searchBtn.disabled = true;
            searchExtractedBtn.disabled = true;
            resultsSection.classList.remove('hidden');
            resultsContent.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block h-10 w-10 border-4 border-[#BF953F]/30 border-t-[#BF953F] rounded-full animate-spin mb-4"></div>
                    <p class="text-gray-400">מחפש נתונים...</p>
                </div>
            `;
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            try {
                const response = await fetch(`/api/vehicle/${licensePlate}`);
                const data = await response.json();

                if (!data.success) {
                    resultsContent.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-5xl text-gray-500 mb-4">search_off</span>
                            <p class="text-gray-400">${data.error || 'לא נמצאו תוצאות עבור מספר רישוי: ' + licensePlate}</p>
                        </div>
                    `;
                    return;
                }

                displayResults(data.data);

            } catch (error) {
                console.error('Error:', error);
                resultsContent.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl text-red-500 mb-4">error</span>
                        <p class="text-red-500">אירעה שגיאה בחיפוש. אנא נסה שנית.</p>
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                if (extractedPlateNumber) {
                    searchExtractedBtn.disabled = false;
                }
            }
        }

        function displayResults(vehicle) {
            const plateNumber = vehicle.mispar_rechev || licensePlateInput.value;

            // Check for warnings
            const warnings = [];
            if (vehicle.rechev_lo_pail) warnings.push('הרכב לא פעיל');
            if (vehicle.rechev_butal) warnings.push('הרכב הורד מהכביש');
            if (vehicle.tipul_baichor) warnings.push('טסט לא בתוקף');
            if (vehicle.recalls && vehicle.recalls.length > 0) warnings.push('קיימות קריאות חוזר');

            let warningBanner = '';
            if (warnings.length > 0) {
                warningBanner = `
                    <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4 mb-4">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-red-500 text-2xl animate-pulse">warning</span>
                            <div>
                                <p class="text-red-400 font-bold mb-1">נמצאו בעיות ברכב!</p>
                                <ul class="text-red-300 text-sm list-disc list-inside">
                                    ${warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }

            const categories = {
                'סטטוס הרכב': {
                    icon: 'verified_user',
                    fields: ['rechev_lo_pail', 'rechev_butal', 'tipul_baichor', 'taarich_bitul']
                },
                'מידע בסיסי': {
                    icon: 'directions_car',
                    fields: ['tozeret_nm', 'kinuy_mishari', 'degem_nm', 'shnat_yitzur', 'tzeva_rechev', 'sug_delek_nm', 'baalut', 'ramat_gimur', 'merkav']
                },
                'מפרט טכני': {
                    icon: 'settings',
                    fields: ['koah_sus', 'nefah_manoa', 'mishkal_kolel', 'mispar_dlatot', 'mispar_moshavim', 'automatic_ind', 'zmig_kidmi', 'zmig_ahori']
                },
                'רישוי ובדיקות': {
                    icon: 'verified',
                    fields: ['tokef_dt', 'misgeret', 'moed_aliya_lakvish', 'rishum_rishon', 'madad_yarok', 'kvutzat_zihum']
                },
                'בעלות והיסטוריה': {
                    icon: 'history',
                    fields: ['mispar_yadayim', 'shinui_baalut_acharon', 'kilometer', 'shinui_mivne', 'shinui_tzeva']
                }
            };

            function formatValue(key, value) {
                let displayValue = value;
                if (key.includes('_dt') && value) {
                    const date = new Date(value);
                    if (!isNaN(date)) displayValue = date.toLocaleDateString('he-IL');
                }
                if (key === 'automatic_ind') displayValue = value === 1 || value === 'A' ? 'כן' : 'לא';
                if (key === 'shinui_mivne' || key === 'shinui_tzeva') displayValue = value === 1 ? 'כן' : 'לא';
                if (key === 'kilometer' && value) displayValue = value.toLocaleString('he-IL') + ' ק"מ';
                return displayValue;
            }

            let categoriesHTML = '';
            const warningFields = ['rechev_lo_pail', 'rechev_butal', 'tipul_baichor'];

            for (const [catName, catData] of Object.entries(categories)) {
                let items = '';
                let hasItems = false;

                for (const key of catData.fields) {
                    const value = vehicle[key];
                    if (value !== undefined && value !== null) {
                        hasItems = true;
                        const label = fieldLabels[key] || key;
                        let displayValue = formatValue(key, value);

                        if (warningFields.includes(key)) {
                            const isWarning = value === true;
                            const textColor = isWarning ? 'text-red-400' : 'text-green-400';
                            const icon = isWarning ? 'cancel' : 'check_circle';

                            if (key === 'rechev_lo_pail') {
                                displayValue = isWarning ? 'לא פעיל' : 'פעיל';
                            } else if (key === 'rechev_butal') {
                                displayValue = isWarning ? 'בוטל' : 'רשום';
                            } else if (key === 'tipul_baichor') {
                                let dateStr = '';
                                if (vehicle.tokef_dt) {
                                    const date = new Date(vehicle.tokef_dt);
                                    if (!isNaN(date)) dateStr = ' (' + date.toLocaleDateString('he-IL') + ')';
                                }
                                displayValue = isWarning ? 'פג תוקף' + dateStr : 'בתוקף' + dateStr;
                            }

                            items += `<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                                <span class="text-sm text-gray-400">${label}</span>
                                <span class="flex items-center gap-1 ${textColor} font-medium text-sm">
                                    <span class="material-symbols-outlined text-base">${icon}</span>${displayValue}
                                </span>
                            </div>`;
                        } else if (key === 'mispar_yadayim' && vehicle.historiat_baalut && vehicle.historiat_baalut.length > 0) {
                            // Display ownership count with detailed history
                            let historyHTML = `<div class="py-2 border-b border-white/5 last:border-0">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-400">${label}</span>
                                    <span class="font-medium text-sm text-white">${displayValue}</span>
                                </div>
                                <div class="mt-2 bg-white/5 rounded-lg p-2">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="text-gray-500 text-xs">
                                                <th class="text-right pb-1">יד</th>
                                                <th class="text-right pb-1">סוג בעלות</th>
                                                <th class="text-right pb-1">תאריך</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;

                            for (const record of vehicle.historiat_baalut) {
                                historyHTML += `<tr class="border-t border-white/5">
                                    <td class="py-1 text-white">${record.yad}</td>
                                    <td class="py-1 text-[#BF953F]">${record.sug_baalut || '-'}</td>
                                    <td class="py-1 text-gray-300">${record.taarich || '-'}</td>
                                </tr>`;
                            }

                            historyHTML += `</tbody></table></div></div>`;
                            items += historyHTML;
                        } else {
                            items += `<div class="flex justify-between items-center py-2 border-b border-white/5 last:border-0">
                                <span class="text-sm text-gray-400">${label}</span>
                                <span class="font-medium text-sm text-white">${displayValue}</span>
                            </div>`;
                        }
                    }
                }

                if (hasItems) {
                    categoriesHTML += `
                        <div class="rounded-lg border border-white/10 bg-white/5 overflow-hidden">
                            <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.expand-icon').classList.toggle('rotate-180')"
                                    class="w-full flex items-center justify-between p-3 hover:bg-white/5 transition-colors">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-[#BF953F]">${catData.icon}</span>
                                    <span class="font-semibold text-white">${catName}</span>
                                </div>
                                <span class="material-symbols-outlined expand-icon transition-transform text-gray-400">expand_more</span>
                            </button>
                            <div class="hidden px-3 pb-3">${items}</div>
                        </div>
                    `;
                }
            }

            resultsContent.innerHTML = `
                ${warningBanner}
                <div class="rounded-lg bg-white/10 p-4 mb-4">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                        <div class="flex flex-col">
                            <p class="text-xl font-bold text-white">
                                ${vehicle.tozeret_nm || ''} ${vehicle.kinuy_mishari || ''}
                            </p>
                            <div class="mt-1 flex flex-wrap gap-x-3 text-sm text-gray-400">
                                <span>${vehicle.shnat_yitzur || ''}</span>
                                <span>•</span>
                                <span>${vehicle.tzeva_rechev || ''}</span>
                                <span>•</span>
                                <span>${vehicle.sug_delek_nm || ''}</span>
                            </div>
                        </div>
                        <span class="bg-[#BF953F] text-black px-4 py-2 rounded-lg text-xl font-extrabold tracking-widest" style="direction: ltr;">${plateNumber}</span>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    ${categoriesHTML}
                </div>
            `;
        }
    </script>
</body>
</html>
